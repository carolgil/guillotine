<% @latex_config={:parse_twice => true} %>

\setkomavar{fromname}{\algslt\scshape wcbn-fm ann arbor}
\setkomavar{fromaddress}{\algslt\scshape 530 student activities bldg.\\515 e.\@
jefferson st.\\ann arbor, mi 48109}
\setkomavar{fromemail}[email: ]{\algslt\scshape dd@wcbn.org}
\setkomavar{signature}{Cameron Bothner\\Development Director\\WCBN-FM Ann
Arbor}

\setkomavar{subject}{Thank you for pledging your support to WCBN!}

\begin{document}


<% @pledgers.each do |pledger| %>
  <% my_donations = (@donations & pledger.donations).sort_by{|d| d.amount}.reverse %>
  <% my_unpaid_donation_total = my_donations.reject(&:payment_received).inject(0) {|sum,don| sum+don.amount} %>
  <% my_paid_donation_total = my_donations.select(&:payment_received).inject(0) {|sum,don| sum+don.amount} %>
  <% my_donation_total = my_unpaid_donation_total + my_paid_donation_total %>
  <% many_donations = (my_donations.length > 17) %>
  <% my_donations = my_donations[0..16] %>
  <% hidden_donations_total = my_donation_total - my_donations.inject(0) {|sum,don| sum+don.amount} %>
  <% my_rewards = @rewards & pledger.rewards %>

  \begin{letter}{<%=lesc pledger.name %>\\
                 <%=lesc pledger.perm_address %>\\
                 <% if !pledger.perm_address2.blank? %>
                   <%=lesc pledger.perm_address2%>\\
                 <% end %>
                 <%= lesc pledger.perm_city%>, <%=lesc pledger.perm_state%> <%= lesc pledger.perm_zip %>}

  \opening{Dear <%=lesc pledger.name.split(" ").first %>,}

  Thanks so much for your support of student-run, freeform,
  experiential--experimental radio at the University of Michigan. Your donation
  supports us in providing students with an inimitable creative and professional
  development experience in music and management, development, engineering, and
  audio production; and providing the listening public with a unique, eclectic
  offering of freeform, specialty, and public affairs shows.


  <% if my_unpaid_donation_total > 0 %>
    Please include the form on the reverse of this letter when you send us
    your payment.  Look for a receipt from the University when
    your donation has been received. 
  <% else %>
    Since we've already received your payment, there's nothing you need to do now but keep listening.
  <% end %>
  <% unless my_rewards.empty? %>
    Thank you gifts will be mailed out when they are available---we appreciate your patience.
  <% end %>
  Once again, thank you so much for your support.

  \closing{Keep listening,}

  \newpage

  \noindent\textbf{Record of pledge to WCBN-FM Ann Arbor}
  \vspace{2em}

  \noindent\emph{Please confirm the following information. Please send any corrections by including them on this form, or by email.}

  \vspace{1em}
  \noindent
  \begin{tabularx}{1\textwidth}{XXX}
  \toprule
  \multicolumn{3}{l}{\textbf{Name: }<%=lesc pledger.name%>}\\
  \multicolumn{2}{l}{\textbf{Email Address: }<%=lesc pledger.email.try &:downcase %>} & 
  \textbf{Telephone:} <%=lesc pledger.perm_phone%> \\
  \multicolumn{3}{l}{\textbf{Address:} <%=lesc pledger.perm_address%>
  <% if !pledger.perm_address2.blank? %>
    <%=lesc pledger.perm_address2%>
  <% end %>}\\
  \textbf{City:} <%= lesc pledger.perm_city%> &
  \textbf{State:} <%=lesc pledger.perm_state%> &
  \textbf{Zip:} <%= lesc pledger.perm_zip %>\\
  \bottomrule
  \end{tabularx}

  \vspace{1em}
  \begin{center}
  \begin{tabularx}{.47\textwidth}{cXr}
  \toprule
  \textbf{Paid?}&\textbf{Itemized Donations}&\textbf{Amount}\\
  \midrule
  <% my_donations.each do |d| %>
    <%= d.payment_received ? '\Checkmark' : '\Square' %> &
    <%= lesc d.slot.show.unambiguous_name %> &
    \$<%= number_with_precision(d.amount, delimiter: ',', precision: 2) %>\\
  <% end %>
  <% if many_donations %>
    & Various other shows & 
    \$<%= number_with_precision(hidden_donations_total, delimiter: ',', precision: 2) %>\\
  <% end %>
  \midrule
  <% if my_paid_donation_total > 0 %>
    & Paid Total: &\$<%= number_with_precision(my_paid_donation_total, delimiter:',', precision:2)%>\\
  <% end %>
  <% if my_unpaid_donation_total > 0 %>
    & \textbf{Unpaid Total:} &\textbf{\$<%= number_with_precision(my_unpaid_donation_total, delimiter:',', precision:2)%>}\\
  <% end %>
  \bottomrule

  \end{tabularx}
  \qquad%
  <% unless my_rewards.empty? %>
    \begin{tabularx}{.47\textwidth}[t!]{X}

    \toprule
    \textbf{Requested Premium Item}\\
    \midrule
    <% my_rewards.each do |r| %>
      <%= lesc r.item.name %>\\
    <% end %>
    \bottomrule
    \end{tabularx}
  <% end %>
  \end{center}
  \vspace{1em}

  \noindent
  \begin{tabularx}{1\textwidth}{XXX}
  <% if my_unpaid_donation_total > 0 %>
    \toprule
    \multicolumn{3}{l}{\Square\hspace{0.5em} Check enclosed, payable to WCBN} \\
    \multicolumn{3}{l}{\Square\hspace{0.5em} Charge my credit card} \\
    \multicolumn{3}{l}{\textbf{Cardholder Name:}}\\
    \midrule
    \multicolumn{3}{l}{\Square\hspace{0.5em} Visa\quad\Square\hspace{0.5em} Mastercard\quad\Square\hspace{0.5em} Amex\quad\Square\hspace{0.5em} Discover}\\
    \multicolumn{3}{l}{\textbf{Card Number:}\hspace{3.5in}\textbf{Expiration:}}\\
    \bottomrule
  <% end %>
  \end{tabularx}

  \end{letter}

<% end %>

\end{document}
